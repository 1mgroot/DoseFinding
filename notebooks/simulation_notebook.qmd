---
title: "Bayesian Dose-Finding Trial Simulation"
format: html
editor: visual
---

## Introduction

This document provides an interactive way to run the Bayesian dose-finding trial simulation. You can modify the simulation parameters in the "Configuration" section and then run the code chunks to see the results.

## Setup

This chunk loads the necessary libraries and source files.

```{r setup}
library(knitr) # For creating formatted tables
library(ggplot2)
source("../src/core/config.R")
source("../src/utils/helpers.R")
source("../src/core/simulate_data.R")
source("../src/core/model_utils.R")
source("../src/decision/dose_decision.R")
source("../src/core/main.R")
```

## Configuration

Modify the simulation parameters in this section. I have adjusted these values to create a more dynamic scenario where multiple doses are likely to be admissible in the early stages.

```{r config}
# Trial configuration
trial_config <- list(
  dose_levels = c(1, 2, 3, 4, 5),
  n_stages = 5,
  cohort_size = 15,
  phi_T = 0.35, # Toxicity threshold (increased slightly)
  c_T = 0.5,   
  phi_E = 0.1, # Efficacy threshold (increased slightly)
  c_E = 0.5,   
  phi_I = 0.20, # Immune response threshold
  c_I = 0.5,   
  # PoC parameters
  c_poc = 0.9,
  delta_poc = 0.8,  # Threshold for PoC comparison
  # Early termination parameters
  enable_early_termination = TRUE,
  log_early_termination = TRUE
)
#cohort size may vary on diff stage (future work)

# Data simulation parameters (designed for a more interesting trial)
p_YI <- c(0.10, 0.30, 0.50, 0.60, 0.70) # Immune response probability

p_YT_given_I <- matrix(c(
  # I=0 (No Immune Response)
  0.05, 0.10, 0.12, 0.18, 0.25,
  # I=1 (Immune Response)
  0.08, 0.12, 0.15, 0.25, 0.35
), nrow = 5, ncol = 2)

p_YE_given_I <- matrix(c(
  # I=0 (No Immune Response)
  0.10, 0.20, 0.35, 0.45, 0.50, 
  # I=1 (Immune Response)
  0.30, 0.50, 0.70, 0.80, 0.75  
), nrow = 5, ncol = 2)

rho0 <- 1.5
rho1 <- 2

# Utility table
# Rows: Efficacy (0, 1)
# Columns: Toxicity (0, 1)
# Slices: Immune Response (0, 1)
utility_table <- array(0, dim = c(2, 2, 2), dimnames = list(
  E = c(0, 1),
  T = c(0, 1),
  I = c(0, 1)
))

utility_table[1, 1, 1] <- 0   # E=0, T=0, I=0
utility_table[2, 1, 1] <- 80  # E=1, T=0, I=0
utility_table[1, 2, 1] <- 0   # E=0, T=1, I=0
utility_table[2, 2, 1] <- 30  # E=1, T=1, I=0

utility_table[1, 1, 2] <- 10  # E=0, T=0, I=1
utility_table[2, 1, 2] <- 100 # E=1, T=0, I=1
utility_table[1, 2, 2] <- 0   # E=0, T=1, I=1
utility_table[2, 2, 2] <- 40  # E=1, T=1, I=1

trial_config$utility_table <- utility_table
```

## Simulation

This chunk runs the multi-stage trial simulation by calling the `run_trial_simulation` function. The simulation follows the workflow specified in TRIAL_DESIGN.md:

1. **Stage 1**: Equal randomization to all dose levels
2. **Interim Analysis**: Update admissible set based on posterior probabilities
3. **Adaptive Randomization**: Allocate patients based on utility scores
4. **Early Termination Check**: Terminate if admissible set is empty
5. **Final Selection**: Choose OD with highest utility from admissible set + PoC validation

```{r simulation}
results <- run_trial_simulation(trial_config, p_YI, p_YT_given_I, p_YE_given_I, rho0, rho1)
```

## Results

This chunk prints the final optimal dose and displays the plots.

```{r results}
# Print final results
cat("
--- Final Results ---
")

if (results$terminated_early) {
  cat("Trial terminated early at stage:", results$termination_stage, "
")
  cat("Reason:", results$termination_reason, "
")
  cat("No Optimal Dose selected
")
} else {
  cat("Final OD:", results$final_od, "
")
  cat("Final utility:", round(results$final_utility, 2), "
")
  cat("PoC validated:", results$poc_validated, "
")
  cat("PoC probability:", round(results$poc_probability, 3), "
")
  cat("Selection reason:", results$selection_reason, "
")
}

# Plot final results and save them
plot_posterior_summary(results$posterior_summaries$imm, title = "Immune Response vs Dose (PAVA Adjusted)", file_path = "results/immune_response_refactored.png")
plot_posterior_summary(results$posterior_summaries$tox, title = "Toxicity Rate by Dose and Immune Status", group_col = "Y_I", file_path = "results/toxicity_refactored.png")
plot_posterior_summary(results$posterior_summaries$eff, title = "Efficacy Rate by Dose and Immune Status", group_col = "Y_I", file_path = "results/efficacy_refactored.png")

# Plot allocation probabilities over time
p_alloc_time <- ggplot(results$all_alloc_probs, aes(x = Stage, y = Prob, color = factor(Dose))) +
  geom_line() +
  geom_point() +
  labs(title = "Allocation Probabilities Over Time", x = "Stage", y = "Allocation Probability", color = "Dose Level") +
  theme_minimal()
print(p_alloc_time)

# Visualize participant allocation with better formatting
# Count participants per dose level and stage
allocation_summary <- results$all_data %>%
  group_by(d, stage) %>%
  summarise(n_participants = n(), .groups = 'drop') %>%
  mutate(d = factor(d), stage = factor(stage, levels = 1:5, labels = paste("Stage", 1:5)))

# Plot 1: Allocation by dose level and stage
p_alloc <- ggplot(allocation_summary, aes(x = d, y = n_participants, fill = stage)) +
  geom_bar(stat = "identity", position = "dodge", width = 0.7) +
  labs(title = "Participant Allocation by Dose Level and Stage", 
       x = "Dose Level", y = "Number of Participants",
       subtitle = paste("Total participants:", sum(allocation_summary$n_participants))) +
  scale_fill_brewer(palette = "Set2", name = "Stage") +
  theme_minimal() +
  theme(plot.title = element_text(size = 14, face = "bold"),
        axis.text = element_text(size = 12),
        axis.title = element_text(size = 12))
print(p_alloc)

# Plot 2: Cumulative allocation over stages
cumulative_summary <- allocation_summary %>%
  group_by(d) %>%
  mutate(cumulative_participants = cumsum(n_participants)) %>%
  ungroup()

p_cumulative <- ggplot(cumulative_summary, aes(x = stage, y = cumulative_participants, color = d, group = d)) +
  geom_line(size = 1.5) +
  geom_point(size = 3) +
  labs(title = "Cumulative Participant Allocation Over Stages", 
       x = "Stage", y = "Cumulative Number of Participants",
       color = "Dose Level",
       subtitle = paste("Final total participants:", sum(allocation_summary$n_participants))) +
  scale_color_brewer(palette = "Set1") +
  theme_minimal() +
  theme(plot.title = element_text(size = 14, face = "bold"),
        axis.text = element_text(size = 12),
        axis.title = element_text(size = 12))
print(p_cumulative)

# Print summary statistics
cat("\n=== ALLOCATION SUMMARY ===\n")
cat("Total participants:", sum(allocation_summary$n_participants), "\n")
cat("Participants per stage:\n")
stage_totals <- allocation_summary %>%
  group_by(stage) %>%
  summarise(total = sum(n_participants), .groups = 'drop')
for(i in 1:nrow(stage_totals)) {
  cat("  Stage", i, ":", stage_totals$total[i], "participants\n")
}

```